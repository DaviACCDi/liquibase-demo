name: Feature Deploy

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Ambiente"
        required: true
        type: choice
        options: [dev, test]
      mode:
        description: "Ação"
        required: true
        type: choice
        options: [apply, plan-only]
        default: apply
      auto_merge:
        description: "Auto-merge PR -> main se DB OK"
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  deploy:
    name: Deploy (${{ inputs.env }} / ${{ inputs.mode }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    concurrency:
      group: feature-db-${{ inputs.env }}
      cancel-in-progress: false
    env:
      LB_DIR: liquibase
      JDBC_URL: ${{ secrets.JDBC_URL }}

    steps:
      - name: Checkout (branch escolhida no Run workflow)
        uses: actions/checkout@v4

      - name: Permissão ao script
        run: chmod +x liquibase/scripts/ci_deploy.sh

      - name: Definir TAG_PRE (para rollback exato)
        run: |
          SAFE_BRANCH=$(echo "${GITHUB_REF_NAME}" | tr '/ ' '--')
          echo "TAG_PRE=feat-${SAFE_BRANCH}-${GITHUB_SHA}-pre" >> $GITHUB_ENV
          echo "TAG_PRE=$TAG_PRE"

      - name: Liquibase apply
        if: inputs.mode == 'apply'
        env:
          TAG_PRE: ${{ env.TAG_PRE }}
        run: |
          ENV_UPPER=$(echo "${{ inputs.env }}" | tr '[:lower:]' '[:upper:]')
          bash liquibase/scripts/ci_deploy.sh "$ENV_UPPER"

      - name: Liquibase plan-only
        if: inputs.mode == 'plan-only'
        run: |
          PROPS="liquibase-${{ inputs.env }}.properties"
          docker run --rm --network host -w /workspace \
            -v "$GITHUB_WORKSPACE/$LB_DIR:/workspace" liquibase/liquibase \
            --defaultsFile="/workspace/conf/$PROPS" \
            --url="$JDBC_URL" validate
          docker run --rm --network host -w /workspace \
            -v "$GITHUB_WORKSPACE/$LB_DIR:/workspace" liquibase/liquibase \
            --defaultsFile="/workspace/conf/$PROPS" \
            --url="$JDBC_URL" updateSQL | tee "plan_$(echo "${{ inputs.env }}" | tr a-z A-Z).sql"

      - name: Artefatos (plan)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ inputs.env }}
          path: plan_*.sql
          if-no-files-found: ignore

      # ====== Auto-merge sem usar actions de terceiros ======

      # Encontrar PR aberto da branch atual -> main
      - name: Encontrar PR aberto para main
        if: inputs.auto_merge == 'true'
        id: findpr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const head  = `${owner}:${context.ref.replace('refs/heads/','')}`;
            const { data: prs } = await github.pulls.list({ owner, repo, state: 'open', head, base: 'main' });
            core.setOutput('number', prs.length ? prs[0].number : '');

      # Se apply OK, faz merge squash e tenta deletar a branch da feature
      - name: Auto-merge PR
        if: inputs.auto_merge == 'true' && steps.findpr.outputs.number != '' && success() && inputs.mode == 'apply'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const prNum = Number('${{ steps.findpr.outputs.number }}');

            const pr = (await github.pulls.get({ owner, repo, pull_number: prNum })).data;

            await github.pulls.merge({
              owner, repo, pull_number: prNum,
              merge_method: 'squash',
              commit_title: pr.title
            });

            const branch = context.ref.replace('refs/heads/','');
            try {
              await github.git.deleteRef({ owner, repo, ref: `heads/${branch}` });
            } catch (e) {
              core.warning(`Não foi possível apagar heads/${branch}: ${e.message}`);
            }

      # Se falhou, comenta no PR informando que foi executado rollback
      - name: Comentar PR (falha + rollback)
        if: inputs.auto_merge == 'true' && steps.findpr.outputs.number != '' && failure() && inputs.mode == 'apply'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const prNum = Number('${{ steps.findpr.outputs.number }}');
            const body  = `❌ Deploy de **${{ inputs.env }}** falhou para \`${process.env.GITHUB_SHA}\`.\n` +
                          `Foi tentado **rollback até a tag \`${process.env.TAG_PRE || '(sem TAG_PRE)'}\`**.\n` +
                          `Veja os logs e ajuste o changeset antes de tentar novamente.`;
            await github.issues.createComment({ owner, repo, issue_number: prNum, body });
