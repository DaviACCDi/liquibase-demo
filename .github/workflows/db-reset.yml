name: DB Reset
run-name: "DB Reset – ${{ inputs.envs || 'manual' }} · ${{ inputs.mode }}"

on:
  workflow_dispatch:
    inputs:
      envs:
        description: "Ambientes (dev,test,prod ou ALL)"
        required: true
        type: string
        default: "dev"
      mode:
        description: "Ação"
        required: true
        type: choice
        options: [apply, plan-only]
        default: plan-only
      confirm:
        description: "Digite RESET para confirmar"
        required: true
        type: string
        default: ""

permissions:
  contents: read

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      env_matrix: ${{ steps.mk.outputs.env_matrix }}
      mode_norm:  ${{ steps.mk.outputs.mode_norm }}
    steps:
      - id: mk
        shell: bash
        run: |
          set -euo pipefail
          IN="${{ inputs.envs }}"
          IN_UP=$(echo "$IN" | tr '[:lower:]' '[:upper:]' | tr -d ' ')

          if [[ "$IN_UP" == "ALL" ]]; then
            ARR='["dev","test","prod"]'
          else
            # normaliza "DEV,TEST" -> ["dev","test"]
            MAP=$(echo "$IN_UP" | tr ',' '\n' | tr '[:upper:]' '[:lower:]' | sed '/^$/d')
            # valida valores
            for e in $MAP; do
              [[ "$e" =~ ^(dev|test|prod)$ ]] || { echo "::error::Ambiente inválido: $e"; exit 2; }
            done
            ARR=$(printf '[%s]\n' "$(echo "$MAP" | sed 's/^/"/; s/$/"/' | paste -sd, -)")
          fi

          MODE_NORM="${{ inputs.mode }}"
          [[ "$MODE_NORM" == "plan-only" ]] && MODE_NORM="plan"

          echo "env_matrix=$ARR"       >> "$GITHUB_OUTPUT"
          echo "mode_norm=$MODE_NORM"  >> "$GITHUB_OUTPUT"

  reset-db:
    needs: prepare
    runs-on: ubuntu-latest

    # roda 1 job por ambiente selecionado, com aprovação/segredos por ambiente
    strategy:
      fail-fast: false
      matrix:
        env: ${{ fromJSON(needs.prepare.outputs.env_matrix) }}
        include:
          - env: dev
          - env: test
          - env: prod

    name: "Reset ${{ matrix.env }} (${{ needs.prepare.outputs.mode_norm }})"
    environment: ${{ matrix.env }}

    concurrency:
      group: db-${{ matrix.env }}-reset
      cancel-in-progress: false

    env:
      LB_DIR: liquibase
      # segredos por ambiente (caem no fallback para JDBC_URL se não existir o específico)
      JDBC_URL: ${{ matrix.env == 'dev'  && (secrets.JDBC_URL_DEV  || secrets.JDBC_URL) ||
                   matrix.env == 'test' && (secrets.JDBC_URL_TEST || secrets.JDBC_URL) ||
                                          (secrets.JDBC_URL_PROD || secrets.JDBC_URL) }}
      ENV_ARG: ${{ matrix.env }}
      MODE:    ${{ needs.prepare.outputs.mode_norm }}

    steps:
      - uses: actions/checkout@v4

      - name: Preflight (${{ matrix.env }})
        shell: bash
        run: |
          set -euo pipefail
          test "${{ inputs.confirm }}" = "RESET" || { echo "::error::Digite RESET para prosseguir"; exit 2; }
          chmod +x "$GITHUB_WORKSPACE/$LB_DIR/scripts/ci_deploy.sh" || true
          test -f "$GITHUB_WORKSPACE/$LB_DIR/conf/liquibase-${{ matrix.env }}.properties" \
            || { echo "::error::liquibase-${{ matrix.env }}.properties ausente"; exit 2; }
          test -f "$GITHUB_WORKSPACE/$LB_DIR/changelogs/db.changelog-master.yaml" \
            || { echo "::error::master changelog ausente"; exit 2; }

      - name: Run Liquibase Reset (${{ matrix.env }})
        env:
          TAG_PRE: reset-${{ matrix.env }}-${{ github.sha }}-pre
        run: |
          # Importante: passamos --contexts=reset para executar só o reset
          bash liquibase/scripts/ci_deploy.sh "${ENV_ARG^^}" --contexts=reset

      - name: Upload plan (${{ matrix.env }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-${{ matrix.env }}
          path: plan_${{ env.ENV_ARG == 'dev' && 'DEV' || env.ENV_ARG == 'test' && 'TEST' || 'PROD' }}.sql
          if-no-files-found: ignore
