name: DB Deploy (jobs com needs)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  dev-deploy:
    name: DEV Deploy
    runs-on: ubuntu-latest
    env:
      LB_DIR: liquibase
      DEV_URL:  jdbc:postgresql://127.0.0.1:5432/appdb_dev
    services:
      postgres-dev:
        image: postgres:15
        env:
          POSTGRES_USER: demo
          POSTGRES_PASSWORD: demo
          POSTGRES_DB: appdb_dev
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd "pg_isready -U demo"
          --health-interval 5s --health-timeout 5s --health-retries 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mostrar contexto e arquivos
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "SHA: ${{ github.sha }}"
          echo "Ref: ${{ github.ref }}"
          echo "LB_DIR: $LB_DIR"
          find "$LB_DIR" -maxdepth 2 -type f -print

      - name: Docker pull liquibase (para logar versão)
        run: |
          docker pull liquibase/liquibase:latest
          docker run --rm liquibase/liquibase --version || true

      - name: DEV - deploy (script)
        id: dev_run
        run: |
          bash liquibase/scripts/ci_deploy.sh DEV

      - name: Publicar plano DEV (artefato)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-DEV
          path: plan_DEV.sql
          if-no-files-found: ignore

  test-deploy:
    name: TEST Deploy
    runs-on: ubuntu-latest
    needs: [dev-deploy]
    env:
      LB_DIR: liquibase
      TEST_URL: jdbc:postgresql://127.0.0.1:5433/appdb_test
    services:
      postgres-test:
        image: postgres:15
        env:
          POSTGRES_USER: demo
          POSTGRES_PASSWORD: demo
          POSTGRES_DB: appdb_test
        ports: [ "5433:5432" ]
        options: >-
          --health-cmd "pg_isready -U demo"
          --health-interval 5s --health-timeout 5s --health-retries 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mostrar contexto e arquivos
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "SHA: ${{ github.sha }}"
          echo "From needs: ${{ needs.dev-deploy.result }}"
          echo "LB_DIR: $LB_DIR"
          find "$LB_DIR" -maxdepth 2 -type f -print

      - name: Docker pull liquibase (para logar versão)
        run: |
          docker pull liquibase/liquibase:latest
          docker run --rm liquibase/liquibase --version || true

      - name: TEST - deploy (script)
        id: test_run
        run: |
          bash liquibase/scripts/ci_deploy.sh TEST

      - name: Publicar plano TEST (artefato)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-TEST
          path: plan_TEST.sql
          if-no-files-found: ignore

  prod-deploy:
    name: PROD Deploy
    runs-on: ubuntu-latest
    needs: [test-deploy]
    env:
      LB_DIR: liquibase
      PROD_URL: jdbc:postgresql://127.0.0.1:5434/appdb_prod
    services:
      postgres-prod:
        image: postgres:15
        env:
          POSTGRES_USER: demo
          POSTGRES_PASSWORD: demo
          POSTGRES_DB: appdb_prod
        ports: [ "5434:5432" ]
        options: >-
          --health-cmd "pg_isready -U demo"
          --health-interval 5s --health-timeout 5s --health-retries 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Mostrar contexto e arquivos
        run: |
          echo "Actor: ${{ github.actor }}"
          echo "SHA: ${{ github.sha }}"
          echo "From needs: ${{ needs.test-deploy.result }}"
          echo "LB_DIR: $LB_DIR"
          find "$LB_DIR" -maxdepth 2 -type f -print

      - name: Docker pull liquibase (para logar versão)
        run: |
          docker pull liquibase/liquibase:latest
          docker run --rm liquibase/liquibase --version || true

      - name: PROD - deploy (script)
        id: prod_run
        run: |
          bash liquibase/scripts/ci_deploy.sh PROD

      - name: Publicar plano PROD (artefato)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: plan-PROD
          path: plan_PROD.sql
          if-no-files-found: ignore

  # (Opcional) Job para agregar os 3 planos de SQL num único bundle, só se tudo passou.
  bundle-plans:
    name: Agregar planos SQL
    runs-on: ubuntu-latest
    needs: [prod-deploy]
    if: ${{ needs.prod-deploy.result == 'success' }}
    steps:
      - name: Baixar plan-DEV
        uses: actions/download-artifact@v4
        with:
          name: plan-DEV
          path: ./plans

      - name: Baixar plan-TEST
        uses: actions/download-artifact@v4
        with:
          name: plan-TEST
          path: ./plans

      - name: Baixar plan-PROD
        uses: actions/download-artifact@v4
        with:
          name: plan-PROD
          path: ./plans

      - name: Listar planos
        run: |
          echo "Arquivos de planos:"
          ls -la ./plans
          echo "Preview finais:"
          for f in ./plans/*.sql; do
            echo "==== $f (últimas 50 linhas) ===="
            tail -n 50 "$f" || true
          done

      - name: Publicar bundle.zip
        run: |
          zip -r plans_bundle.zip ./plans
        continue-on-error: true

      - name: Upload bundle
        uses: actions/upload-artifact@v4
        with:
          name: sql-plans-bundle
          path: plans_bundle.zip
          if-no-files-found: ignore
