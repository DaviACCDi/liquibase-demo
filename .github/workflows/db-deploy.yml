name: Liquibase Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  dev-deploy:
    name: DEV Deploy
    runs-on: ubuntu-latest
    environment: dev
    env:
      LB_DIR: liquibase
      JDBC_URL: ${{ secrets.JDBC_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Garantir permissão no script
        run: chmod +x liquibase/scripts/ci_deploy.sh

      - name: Rodar Liquibase no DEV
        run: bash liquibase/scripts/ci_deploy.sh DEV

      - name: Conferir tabelas no DEV
        run: |
          echo "=== [DEV] Conferindo tabelas ==="
          PGPASSWORD=$(echo $JDBC_URL | sed -E 's/.*password=([^&]+).*/\1/') \
          psql "$(echo $JDBC_URL | sed -E 's/^jdbc:postgresql:/postgres:/')" \
            -c "\dt"

  test-deploy:
    name: TEST Deploy
    runs-on: ubuntu-latest
    needs: [dev-deploy]
    environment: test
    env:
      LB_DIR: liquibase
      JDBC_URL: ${{ secrets.JDBC_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Garantir permissão no script
        run: chmod +x liquibase/scripts/ci_deploy.sh

      - name: Rodar Liquibase no TEST
        run: bash liquibase/scripts/ci_deploy.sh TEST

      - name: Conferir tabelas no TEST
        run: |
          echo "=== [TEST] Conferindo tabelas ==="
          PGPASSWORD=$(echo $JDBC_URL | sed -E 's/.*password=([^&]+).*/\1/') \
          psql "$(echo $JDBC_URL | sed -E 's/^jdbc:postgresql:/postgres:/')" \
            -c "\dt"

  prod-deploy:
    name: PROD Deploy
    runs-on: ubuntu-latest
    needs: [test-deploy]
    environment: 
      name: prod
      url: https://render.com     # opcional, só pra referência
    env:
      LB_DIR: liquibase
      JDBC_URL: ${{ secrets.JDBC_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Garantir permissão no script
        run: chmod +x liquibase/scripts/ci_deploy.sh

      - name: Rodar Liquibase no PROD
        run: bash liquibase/scripts/ci_deploy.sh PROD

      - name: Conferir tabelas no PROD
        run: |
          echo "=== [PROD] Conferindo tabelas ==="
          PGPASSWORD=$(echo $JDBC_URL | sed -E 's/.*password=([^&]+).*/\1/') \
          psql "$(echo $JDBC_URL | sed -E 's/^jdbc:postgresql:/postgres:/')" \
            -c "\dt"
